#! /usr/bin/perl

use strict;	# $Id: fixown 272 2013-10-18 15:45:06Z JECottrell3@gmail.com $
use integer;

$| = 1;
my $debug = 0;
my $exec  = 0;
my $waltz = 1;	# suppress
my $bimas = 1;	# suppress
my $noop  = 0;
my $gonly = 0;
# User UID/GID
my (%name, %ogid, %nuid);	# Indexed by Old UID
my $count = 0;			# File Count
my $date;

chomp($date = `date`);
print ": BEGIN $date $0 @ARGV\n";	# signon
################################################################
#	Option Processing
################################################################

while ($ARGV[0] =~ m/^-/)
{
	++$debug if ($ARGV[0] eq '-d');
	++$exec  if ($ARGV[0] eq '-x');
	--$waltz if ($ARGV[0] eq '-w');
	--$bimas if ($ARGV[0] eq '-b');
	++$noop  if ($ARGV[0] eq '-n');
	++$gonly if ($ARGV[0] eq '-g');
	shift;
}


@ARGV && open ARGV, "find @ARGV -xdev|";

###############################################################
#	Build Transmat Table, indexed by Old UID
################################################################

while (<DATA>)
{
	my ($name, $uid, $gid, $nid, $flag) = split ' ';
	my $OK = 0;
	   $OK = 1 if ($noop);
	   $OK = 1 if ($flag eq 'CHANGE');
	   $OK = 1 if ($flag eq 'GROUP' && $gonly);
	next unless $OK;
	++$count;
	$ogid{$uid} = $gid;	# old GID
	$nuid{$uid} = $nid;	# new UID
	$name{$uid} = $name;	# old user name
	$name{$nid} = $name;	# new user name
}
close DATA;
$debug && print ": $count accounts\n";

################################################################
#	File Fixer
################################################################

my $total  = 0;
my $chown  = 0;
my $chgrp  = 0;

while (<>)
{
	++$total;
	# exclusions
	next if ($waltz && m%^/export/./waltz2?/%);
	next if ($waltz && m%^/var/backup2?/%);
	next if ($waltz && m%^/export/./backup2?/%);
	next if (m%^/media/%);
	next if (m%^/misc/%);
	next if ($bimas && m%^/bimas%i);
	next if ($bimas && m%/readonly_bimas/%);
	next if ($bimas && m%^/usr[_/]local/bimas/%i);
	next if ($bimas && m%^/old_bimas_disks/%);

	chomp(my $path = $_);

	# File UID/GID
	my ($fuid, $fgid) = (lstat $path)[4, 5];
	my ($suid, $sgid) = (-1, -1);
	my $nuid;
	my $ogid;
	my $name;

	my $type = -l _ ? 'link' : -d _ ? 'dir' : 'file';

	if ($fuid >= 1000000)	# UID converted, GID = Evil
	{
		$nuid = $fuid;
		$ogid = -1;
	} else {		# Normal, unconverted
		$nuid = $nuid{$fuid}; next unless ($nuid);
		$ogid = $ogid{$fuid}; die  unless ($ogid);
	}

	$name = $name{$fuid} || 'NOUSER';

	# system call parms
	$suid = $nuid == $fuid ? -1 : $nuid;
	$suid = -1 if ($gonly);
	$sgid = $ogid != $fgid ? -1 : $nuid;

	# Evil GIDs
	$sgid = $nuid if $fgid == 99;
	$sgid = $nuid if $fgid == 199;
	$sgid = $nuid if $fgid == 32892;		# old hassan
	$sgid = $nuid if $fgid == 65534;
	$sgid = $nuid if $fgid == 4294967294;

	next if ($suid == -1 && $sgid == -1);		# no change
	next if ($ogid == $nuid);			# redundant
	
	my $carg  = $suid > 0 ?  "$suid" : '';		# command
	   $carg .= $sgid > 0 ? ":$sgid" : '';		#    line
	my $sarg  = sprintf "%d,%d,", $suid, $sgid;	# syscall

	# External CHOWN

	my $cmd = $noop ? ': own' : 'chown';

	$debug &&
	printf ":  $type\t %-24s'%s' # $name\n", "$fuid:$fgid", $path;
#	$debug &&
#	printf "## %s(%-24s'%s')  %s\n", $cmd, $sarg, $path, $name;
	printf "%s -h %-24s'%s' # %s\n", $cmd, $carg, $path, $name; 

	next     if($noop);
	next unless($exec);

	# Internal CHOWN

	++$chown if ($suid != -1);
	++$chgrp if ($sgid != -1);
	$type == 'link' ?
#		`chown -h $carg "$path"` :	# no lchown
		system	'chown', '-h', $carg, $path :	# no lchown
			 chown($suid, $sgid,  $path);	# internal
}

chomp($date = `date`);
print ":  END  $date $0 chown: $chown chgrp: $chgrp total: $total.\n";	# signoff
exit;

################################################################
#		Account Data
################################################################

__END__
schwitrs	21379		199		  1011990	CHANGE
leeys		32859		99		  1012059	CHANGE
yongslee	3183		99		  1012059	MAYBE
jrcaston	30871		99		200058867	CHANGE
jtomlin		1478		99		  1010891	CHANGE
yuanx4		200105305	99		200105305	CHANGE
yryabov		32756		199		  1353007	CHANGE
yings		27952		99		  1081861	CHANGE
yangy10		34210		99		  1443932	CHANGE
xiaowen		31346		99		  1215942	CHANGE
xiangz		30358		30358		  1162370	CHANGE
wbarker		33069		522		  1013557	CHANGE
wangk3		34537		99		200055987	CHANGE
wangh3		32075		99		  1258615	CHANGE
wangg3		33811		100		  1436682	CHANGE
wangal		27824		99		  1066192	CHANGE
vsam		29751		99		  1150647	CHANGE
vovko		33402		99		  1298484	CHANGE
trusb		33101		99		  1015959	CHANGE
thottu		32575		199		  1338269	CHANGE
tgmyers		2858		99		  1131300	CHANGE
talleye		1224489		99		  1224489	CHANGE
sungiun		31911		100		  1219771	CHANGE
sthada		30903		522		  1143270	CHANGE
steinbac	2286		99		  1015297	CHANGE
smallkm		200107939	99		200107939	CHANGE
sincanm		33977		99		  1434312	CHANGE
shojaeis	34825		99		200068628	CHANGE
shens2		35427		99		  1434108	CHANGE
shahjiga	31592		99		  1234695	CHANGE
senthilgs	35131		547		200037274	CHANGE
senseneyj	33401		100		  1301002	CHANGE
sebastiany	1438035		99		  1438035	CHANGE
sconant		30695		522		  1015468	CHANGE
schintal	29291		99		  1144227	CHANGE
sandor		1207		99		  1006652	CHANGE
salem		1009402		99		  1009402	CHANGE
ruida		33395		100		  1147141	CHANGE
rothmb		33887		199		  1438785	CHANGE
ravindrana2	33547		99		  1429966	CHANGE
rasbandw	34491		99		  1016744	CHANGE
rangelzg	33227		99		  1153683	CHANGE
raisa		9624		99		  1011319	CHANGE
qiuh2		33233		99		  1258554	CHANGE
pursley		18076		99		  1015619	CHANGE
phungth		30003		99		  1056200	CHANGE
parkja2		34572		99		200056846	CHANGE
pandyan		33396		100		  1298481	CHANGE
pajevic		5905		99		  1009824	CHANGE
munson		1258		99		  1006155	CHANGE
msteele		27374		99		  1004902	CHANGE
moj2		200115232	99		200115232	CHANGE
mcqueenp	9237		99		  1015451	CHANGE
mcmatt		14682		99		  1015120	CHANGE
mccreedy	28781		99		  1127027	CHANGE
maudsleyst	35439		99		  1154068	CHANGE
martinbro	35438		99		  1161914	CHANGE
lynny		27109		99		  1019834	CHANGE
luqued		500		99		200058862	CHANGE
liz7		34429		99		200052018	CHANGE
liux8		34034		99		  1441445	CHANGE
liud2		33228		99		  1120817	CHANGE
liowj		28672		522		  1101006	CHANGE
lhamlin		33724		199		  1156294	CHANGE
lauwill		32378		99		  1240113	CHANGE
kuors		35441		99		200103333	CHANGE
kmeyer		2841		99		  1056953	CHANGE
khokd		33744		100		  1434385	CHANGE
kempner		5338		99		  1006258	CHANGE
kcdb		34664		99		  1440313	CHANGE
kakareka	70000		99		  1006354	CHANGE
jytian		33148		99		  1388891	CHANGE
joshim2		33397		100		  1298482	CHANGE
johnson		1242		501		  1066755	CHANGE
johnk		3588		99		  1040027	CHANGE
joehanesr	34473		99		  1441361	CHANGE
jmalley		3104		99		  1017343	CHANGE
jip		1203		99		  1010904	CHANGE
jim3		33940		99		  1439786	CHANGE
ilb		20793		100		  1006013	CHANGE
gandler		4903		99		  1006013	MAYBE
huangj10	200118504	99		200118504	CHANGE
hok		200115241	99		200115241	CHANGE
hillpa		32547		99		  1065508	CHANGE
heyiwen		30986		99		  1195801	CHANGE
hassan		32892		32892		  1156786	CHANGE
haquee		35132		547		  1416272	CHANGE
greenmanrb	32881		6002		  1366709	CHANGE
glanowskisa	33463		100		  1420534	CHANGE
gladdingr	31438		536		  1206885	CHANGE
gebremichaelt	34573		99		  1352588	CHANGE
garnerjr	33008		100		  1350813	CHANGE
frazina		29314		99		  1145188	CHANGE
engj		34617		99		  1368547	CHANGE
easaki		27060		99		  1056077	CHANGE
druss		27812		99		  1066191	CHANGE
dpot		34186		99		  1222484	MAYBE
doant		31282		99		  1211802	CHANGE
dagdug		28374		99		  1107639	CHANGE
coynem		32132		99		  1237789	CHANGE
cottrell	200115213	99		200115213	CHANGE
colliekr	33572		99		  1147859	CHANGE
cheungh		27871		99		  1072415	CHANGE
chenh10		35437		99		200098983	CHANGE
chengs6		34864		99		200070852	CHANGE
changd4		33692		100		  1432850	CHANGE
butchersg	35056		199		200080654	CHANGE
bornsteinat	34365		99		200049842	CHANGE
bermejog	33889		199		  1376709	CHANGE
barbj		28197		99		  1106445	CHANGE
arif		11916		199		  1052063	CHANGE
goldins         32629   	99      	  1330624	CHANGE
