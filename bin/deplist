#! /usr/bin/perl

$REPO = $ARGV[0] || "/repo/CentOS/5.2/i386/CentOS";

$out = $ARGV[1] || "deplist";
$out =~ s%.*/%%;

@ARGV = <$REPO/*>;

FILE:
for $ARGV (@ARGV)
{
	for ($ARGV)
	{
		warn("$_: not an RPM\n"), next FILE
			unless (s/.rpm$//);

		s%.*/%%;	# nuke dirs
		s/-[^-]*$//;	# nuke version
		s/-[^-]*$//;	# nuke release
	}

#$f = -f "dep/$ARGV";
#print("-f 'dep/$ARGV' = $f\n");
	print("$ARGV-"), next if (-f "dep/$ARGV");
	print("$ARGV...");
	open(OUT, "> dep/$ARGV") or die;
	open(YUM, "yum deplist $ARGV|") or die;

	%dep = ();
	while ($_ = <YUM>)
	{
		($x, $y, $z) = split(' ');
		$dep = $y		if $x =~ /dependency:/;
		$dep{$y} = $dep		if $x =~ /provider:/;
	}
	map { printf(OUT "%-32s%s\n", $_, $dep{$_}); } sort(keys(%dep));
	close(YUM); close(OUT);
}

print("DONE.\n");
